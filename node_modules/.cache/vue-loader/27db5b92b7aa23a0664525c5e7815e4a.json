{"remainingRequest":"E:\\IDEA\\project\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!E:\\IDEA\\project\\ant-design-vue-jeecg\\src\\views\\user\\LoginSelectTenant.vue?vue&type=script&lang=js&","dependencies":[{"path":"E:\\IDEA\\project\\ant-design-vue-jeecg\\src\\views\\user\\LoginSelectTenant.vue","mtime":1715586474321},{"path":"E:\\IDEA\\project\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1621061384845},{"path":"E:\\IDEA\\project\\ant-design-vue-jeecg\\node_modules\\babel-loader\\lib\\index.js","mtime":1621061377995},{"path":"E:\\IDEA\\project\\ant-design-vue-jeecg\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1621061384845},{"path":"E:\\IDEA\\project\\ant-design-vue-jeecg\\node_modules\\vue-loader\\lib\\index.js","mtime":1621061372054}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\n\r\nimport Vue from 'vue'\r\nimport { getAction, putAction } from '@/api/manage'\r\nimport { USER_INFO } from '@/store/mutation-types'\r\n\r\nexport default {\r\n  name: 'LoginSelectTenant',\r\n  data() {\r\n    return {\r\n      visible: false,\r\n      isMultiDepart: false,\r\n      departList: [],\r\n\r\n      isMultiTenant: false,\r\n      tenantList: [],\r\n\r\n      username: '',\r\n      orgCode: '',\r\n      tenant_id: '',\r\n\r\n      validate_status1: '',\r\n      validate_status2: ''\r\n    }\r\n  },\r\n  computed: {\r\n    title() {\r\n      if (this.isMultiDepart && this.isMultiTenant) {\r\n        return '请选择租户和部门'\r\n      } else if (this.isMultiDepart && !this.isMultiTenant) {\r\n        return '请选择部门'\r\n      } else if (!this.isMultiDepart && this.isMultiTenant) {\r\n        return '请选择租户'\r\n      }\r\n    }\r\n  },\r\n  methods: {\r\n    clear() {\r\n      this.departList = []\r\n      this.tenantList = []\r\n      this.visible = false\r\n      this.validate_status1 = ''\r\n      this.validate_status2 = ''\r\n    },\r\n    bizDepart(loginResult) {\r\n      let multi_depart = loginResult.multi_depart\r\n      //0:无部门 1:一个部门 2:多个部门\r\n      if (multi_depart == 0) {\r\n        this.$notification.warn({\r\n          message: '提示',\r\n          description: `您尚未归属部门,请确认账号信息`,\r\n          duration: 3\r\n        })\r\n        this.isMultiDepart = false\r\n      } else if (multi_depart == 2) {\r\n        this.visible = true\r\n        this.isMultiDepart = true\r\n        this.departList = loginResult.departs\r\n      } else {\r\n        this.isMultiDepart = false\r\n      }\r\n    },\r\n    bizTenant(ids) {\r\n      if (!ids || ids.length == 0) {\r\n        this.isMultiTenant = false\r\n      } else if (ids.indexOf(',') < 0) {\r\n        this.tenant_id = ids\r\n        this.isMultiTenant = false\r\n      } else {\r\n        this.visible = true\r\n        this.isMultiTenant = true\r\n        getAction('/sys/tenant/queryList', { ids: ids }).then(res => {\r\n          this.tenantList = res.result\r\n        })\r\n      }\r\n    },\r\n    show(loginResult) {\r\n      this.clear()\r\n      this.bizDepart(loginResult)\r\n\r\n      let user = Vue.ls.get(USER_INFO)\r\n      this.username = user.username\r\n      let ids = user.relTenantIds\r\n      this.bizTenant(ids)\r\n\r\n      if (this.visible === false) {\r\n        this.$store.dispatch('saveTenant', this.tenant_id)\r\n        this.$emit('success')\r\n      }\r\n    },\r\n    requestFailed(err) {\r\n      this.$notification['error']({\r\n        message: '登录失败',\r\n        description: ((err.response || {}).data || {}).message || err.message || '请求出现错误，请稍后再试',\r\n        duration: 4\r\n      })\r\n      this.loginBtn = false\r\n    },\r\n    departResolve() {\r\n      return new Promise((resolve, reject) => {\r\n        if (this.isMultiDepart === false) {\r\n          resolve()\r\n        } else {\r\n          let obj = {\r\n            orgCode: this.orgCode,\r\n            username: this.username\r\n          }\r\n          putAction('/sys/selectDepart', obj).then(res => {\r\n            if (res.success) {\r\n              const userInfo = res.result.userInfo\r\n              Vue.ls.set(USER_INFO, userInfo, 7 * 24 * 60 * 60 * 1000)\r\n              this.$store.commit('SET_INFO', userInfo)\r\n              //console.log(\"---切换组织机构---userInfo-------\",store.getters.userInfo.orgCode);\r\n              resolve()\r\n            } else {\r\n              this.requestFailed(res)\r\n              this.$store.dispatch('Logout')\r\n              reject()\r\n            }\r\n          })\r\n        }\r\n      })\r\n    },\r\n    selectOk() {\r\n      if (this.isMultiTenant && !this.tenant_id) {\r\n        this.validate_status1 = 'error'\r\n        return false\r\n      }\r\n      if (this.isMultiDepart && !this.orgCode) {\r\n        this.validate_status2 = 'error'\r\n        return false\r\n      }\r\n      this.departResolve().then(() => {\r\n        this.$store.dispatch('saveTenant', this.tenant_id)\r\n        if (this.isMultiTenant) {\r\n          this.$emit('success')\r\n        } else {\r\n          this.$emit('success')\r\n        }\r\n      }).catch(() => {\r\n        console.log('登录选择出问题')\r\n      })\r\n    },\r\n    handleTenantChange(e) {\r\n      this.validate_status1 = ''\r\n      this.tenant_id = e\r\n    },\r\n    handleDepartChange(e) {\r\n      this.validate_status2 = ''\r\n      this.orgCode = e\r\n    }\r\n  }\r\n}\r\n",{"version":3,"sources":["LoginSelectTenant.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsDA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"LoginSelectTenant.vue","sourceRoot":"src/views/user","sourcesContent":["<template>\r\n  <a-modal\r\n    :title=\"title\"\r\n    :width=\"450\"\r\n    :visible=\"visible\"\r\n    :closable=\"false\"\r\n    :maskClosable=\"false\">\r\n\r\n    <template slot=\"footer\">\r\n      <a-button type=\"primary\" @click=\"selectOk\">确认</a-button>\r\n    </template>\r\n\r\n    <a-form>\r\n      <!--      <a-form-item v-if=\"isMultiTenant\" :labelCol=\"{span:4}\" :wrapperCol=\"{span:20}\" style=\"margin-bottom:10px\" :validate-status=\"validate_status1\">-->\r\n      <!--        <a-tooltip placement=\"topLeft\" >-->\r\n      <!--          <template slot=\"title\">-->\r\n      <!--            <span>您有多个租户，请选择登录租户</span>-->\r\n      <!--          </template>-->\r\n      <!--        <a-avatar style=\"backgroundColor:#87d068\" icon=\"gold\" />-->\r\n      <!--        </a-tooltip>-->\r\n\r\n      <!--        <a-select @change=\"handleTenantChange\" :class=\"{'valid-error':validate_status1=='error'}\" placeholder=\"请选择登录租户\" style=\"margin-left:10px;width: 80%\">-->\r\n      <!--          <a-icon slot=\"suffixIcon\" type=\"gold\" />-->\r\n      <!--          <a-select-option v-for=\"d in tenantList\" :key=\"d.id\" :value=\"d.id\">-->\r\n      <!--            {{ d.name }}-->\r\n      <!--          </a-select-option>-->\r\n      <!--        </a-select>-->\r\n      <!--      </a-form-item>-->\r\n\r\n\r\n      <a-form-item v-if=\"isMultiDepart\" :labelCol=\"{span:4}\" :wrapperCol=\"{span:20}\" style=\"margin-bottom:10px\"\r\n                   :validate-status=\"validate_status2\">\r\n        <a-tooltip placement=\"topLeft\">\r\n          <template slot=\"title\">\r\n            <span>您有多个部门，请选择登录部门</span>\r\n          </template>\r\n          <a-avatar style=\"backgroundColor:rgb(104, 208, 203);\" icon=\"gold\"/>\r\n        </a-tooltip>\r\n\r\n        <a-select @change=\"handleDepartChange\" :class=\"{'valid-error':validate_status2=='error'}\"\r\n                  placeholder=\"请选择登录部门\" style=\"margin-left:10px;width: 80%\">\r\n          <a-icon slot=\"suffixIcon\" type=\"gold\"/>\r\n          <a-select-option v-for=\"d in departList\" :key=\"d.id\" :value=\"d.orgCode\">\r\n            {{ d.departName }}\r\n          </a-select-option>\r\n        </a-select>\r\n      </a-form-item>\r\n\r\n    </a-form>\r\n  </a-modal>\r\n</template>\r\n\r\n<script>\r\n\r\nimport Vue from 'vue'\r\nimport { getAction, putAction } from '@/api/manage'\r\nimport { USER_INFO } from '@/store/mutation-types'\r\n\r\nexport default {\r\n  name: 'LoginSelectTenant',\r\n  data() {\r\n    return {\r\n      visible: false,\r\n      isMultiDepart: false,\r\n      departList: [],\r\n\r\n      isMultiTenant: false,\r\n      tenantList: [],\r\n\r\n      username: '',\r\n      orgCode: '',\r\n      tenant_id: '',\r\n\r\n      validate_status1: '',\r\n      validate_status2: ''\r\n    }\r\n  },\r\n  computed: {\r\n    title() {\r\n      if (this.isMultiDepart && this.isMultiTenant) {\r\n        return '请选择租户和部门'\r\n      } else if (this.isMultiDepart && !this.isMultiTenant) {\r\n        return '请选择部门'\r\n      } else if (!this.isMultiDepart && this.isMultiTenant) {\r\n        return '请选择租户'\r\n      }\r\n    }\r\n  },\r\n  methods: {\r\n    clear() {\r\n      this.departList = []\r\n      this.tenantList = []\r\n      this.visible = false\r\n      this.validate_status1 = ''\r\n      this.validate_status2 = ''\r\n    },\r\n    bizDepart(loginResult) {\r\n      let multi_depart = loginResult.multi_depart\r\n      //0:无部门 1:一个部门 2:多个部门\r\n      if (multi_depart == 0) {\r\n        this.$notification.warn({\r\n          message: '提示',\r\n          description: `您尚未归属部门,请确认账号信息`,\r\n          duration: 3\r\n        })\r\n        this.isMultiDepart = false\r\n      } else if (multi_depart == 2) {\r\n        this.visible = true\r\n        this.isMultiDepart = true\r\n        this.departList = loginResult.departs\r\n      } else {\r\n        this.isMultiDepart = false\r\n      }\r\n    },\r\n    bizTenant(ids) {\r\n      if (!ids || ids.length == 0) {\r\n        this.isMultiTenant = false\r\n      } else if (ids.indexOf(',') < 0) {\r\n        this.tenant_id = ids\r\n        this.isMultiTenant = false\r\n      } else {\r\n        this.visible = true\r\n        this.isMultiTenant = true\r\n        getAction('/sys/tenant/queryList', { ids: ids }).then(res => {\r\n          this.tenantList = res.result\r\n        })\r\n      }\r\n    },\r\n    show(loginResult) {\r\n      this.clear()\r\n      this.bizDepart(loginResult)\r\n\r\n      let user = Vue.ls.get(USER_INFO)\r\n      this.username = user.username\r\n      let ids = user.relTenantIds\r\n      this.bizTenant(ids)\r\n\r\n      if (this.visible === false) {\r\n        this.$store.dispatch('saveTenant', this.tenant_id)\r\n        this.$emit('success')\r\n      }\r\n    },\r\n    requestFailed(err) {\r\n      this.$notification['error']({\r\n        message: '登录失败',\r\n        description: ((err.response || {}).data || {}).message || err.message || '请求出现错误，请稍后再试',\r\n        duration: 4\r\n      })\r\n      this.loginBtn = false\r\n    },\r\n    departResolve() {\r\n      return new Promise((resolve, reject) => {\r\n        if (this.isMultiDepart === false) {\r\n          resolve()\r\n        } else {\r\n          let obj = {\r\n            orgCode: this.orgCode,\r\n            username: this.username\r\n          }\r\n          putAction('/sys/selectDepart', obj).then(res => {\r\n            if (res.success) {\r\n              const userInfo = res.result.userInfo\r\n              Vue.ls.set(USER_INFO, userInfo, 7 * 24 * 60 * 60 * 1000)\r\n              this.$store.commit('SET_INFO', userInfo)\r\n              //console.log(\"---切换组织机构---userInfo-------\",store.getters.userInfo.orgCode);\r\n              resolve()\r\n            } else {\r\n              this.requestFailed(res)\r\n              this.$store.dispatch('Logout')\r\n              reject()\r\n            }\r\n          })\r\n        }\r\n      })\r\n    },\r\n    selectOk() {\r\n      if (this.isMultiTenant && !this.tenant_id) {\r\n        this.validate_status1 = 'error'\r\n        return false\r\n      }\r\n      if (this.isMultiDepart && !this.orgCode) {\r\n        this.validate_status2 = 'error'\r\n        return false\r\n      }\r\n      this.departResolve().then(() => {\r\n        this.$store.dispatch('saveTenant', this.tenant_id)\r\n        if (this.isMultiTenant) {\r\n          this.$emit('success')\r\n        } else {\r\n          this.$emit('success')\r\n        }\r\n      }).catch(() => {\r\n        console.log('登录选择出问题')\r\n      })\r\n    },\r\n    handleTenantChange(e) {\r\n      this.validate_status1 = ''\r\n      this.tenant_id = e\r\n    },\r\n    handleDepartChange(e) {\r\n      this.validate_status2 = ''\r\n      this.orgCode = e\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n\r\n</style>"]}]}